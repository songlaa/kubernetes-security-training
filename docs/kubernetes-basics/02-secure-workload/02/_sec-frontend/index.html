<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Securing the frontend | Kubernetes Security Training</title>
<meta name=description content="Right now we have a fully functioning application, but we want to run it as securely as possible. In Docker, we would make sure to run as an unprivileged user, drop unnecessary capabilities and use a Mandatory Access Control System like AppArmor. Let us apply that to Kubernetes!
In Kubernetes, the SecurityContext defines security-related settings for both Pods and individual Containers. It allows you to control various security aspects of your workloads, such as user permissions, capabilities, and Linux security features (like SELinux, AppArmor, and seccomp)."><meta property="og:title" content="Securing the frontend"><meta property="og:description" content="Right now we have a fully functioning application, but we want to run it as securely as possible. In Docker, we would make sure to run as an unprivileged user, drop unnecessary capabilities and use a Mandatory Access Control System like AppArmor. Let us apply that to Kubernetes!
In Kubernetes, the SecurityContext defines security-related settings for both Pods and individual Containers. It allows you to control various security aspects of your workloads, such as user permissions, capabilities, and Linux security features (like SELinux, AppArmor, and seccomp)."><meta property="og:type" content="article"><meta property="og:url" content="/docs/kubernetes-basics/02-secure-workload/02/_sec-frontend/"><meta property="article:section" content="docs"><meta property="article:modified_time" content="2024-11-05T09:51:14+01:00"><meta itemprop=name content="Securing the frontend"><meta itemprop=description content="Right now we have a fully functioning application, but we want to run it as securely as possible. In Docker, we would make sure to run as an unprivileged user, drop unnecessary capabilities and use a Mandatory Access Control System like AppArmor. Let us apply that to Kubernetes!
In Kubernetes, the SecurityContext defines security-related settings for both Pods and individual Containers. It allows you to control various security aspects of your workloads, such as user permissions, capabilities, and Linux security features (like SELinux, AppArmor, and seccomp)."><meta itemprop=dateModified content="2024-11-05T09:51:14+01:00"><meta itemprop=wordCount content="1061"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="Securing the frontend"><meta name=twitter:description content="Right now we have a fully functioning application, but we want to run it as securely as possible. In Docker, we would make sure to run as an unprivileged user, drop unnecessary capabilities and use a Mandatory Access Control System like AppArmor. Let us apply that to Kubernetes!
In Kubernetes, the SecurityContext defines security-related settings for both Pods and individual Containers. It allows you to control various security aspects of your workloads, such as user permissions, capabilities, and Linux security features (like SELinux, AppArmor, and seccomp)."><link rel=preload href=/scss/main.min.a640f285742d63fc54f2d0a8831ec7331ffac626070575a64961fc7e06c1bf34.css as=style><link href=/scss/main.min.a640f285742d63fc54f2d0a8831ec7331ffac626070575a64961fc7e06c1bf34.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.7.1.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous></script></head><body class=td-page><header><nav class="td-navbar js-navbar-scroll" data-bs-theme=dark><div class="container-fluid flex-column flex-md-row"><a class=navbar-brand href=/><span class="navbar-brand__logo navbar-logo"></span><span class=navbar-brand__name>Kubernetes Security Training</span></a><div class="td-navbar-nav-scroll ms-md-auto" id=main_navbar><ul class=navbar-nav><li class=nav-item><a class=nav-link href=/setup/><span>Setup</span></a></li><li class=nav-item><a class=nav-link href=/slides/><span>Slides</span></a></li><li class=nav-item><a class=nav-link href=https://songlaa.com target=_blank rel=noopener><span>songlaa gmbh</span></a></li></ul></div><div class="d-none d-lg-block"></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><form class="td-sidebar__search d-flex align-items-center"><button class="btn btn-link td-sidebar__toggle d-md-none p-0 ms-3 fas fa-bars" type=button data-bs-toggle=collapse data-bs-target=#td-section-nav aria-controls=td-section-nav aria-expanded=false aria-label="Toggle section navigation"></button></form><nav class="td-sidebar-nav collapse" id=td-section-nav><ul class="td-sidebar-nav__section pe-md-3 ul-0"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-docs-li><a href=/docs/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-docs><span>Labs</span></a><ul class=ul-1><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docskubernetes-basics01-basics-li><a href=/docs/kubernetes-basics/01-basics/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-docskubernetes-basics01-basics><span>1. Basics</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docskubernetes-basics01-basics01_introduction-li><a href=/docs/kubernetes-basics/01-basics/01/_introduction/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docskubernetes-basics01-basics01_introduction><span>1.1. Introduction</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docskubernetes-basics01-basics01_deployments-li><a href=/docs/kubernetes-basics/01-basics/01/_deployments/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docskubernetes-basics01-basics01_deployments><span>1.2. Deployments</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docskubernetes-basics01-basics01_service-li><a href=/docs/kubernetes-basics/01-basics/01/_service/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docskubernetes-basics01-basics01_service><span>1.3. Exposing a Service</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docskubernetes-basics01-basics01_database-li><a href=/docs/kubernetes-basics/01-basics/01/_database/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docskubernetes-basics01-basics01_database><span>1.4. Backend</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-docskubernetes-basics02-secure-workload-li><a href=/docs/kubernetes-basics/02-secure-workload/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-docskubernetes-basics02-secure-workload><span>2. Secure Workload</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id=m-docskubernetes-basics02-secure-workload02_sec-frontend-li><a href=/docs/kubernetes-basics/02-secure-workload/02/_sec-frontend/ class="align-left ps-0 active td-sidebar-link td-sidebar-link__page" id=m-docskubernetes-basics02-secure-workload02_sec-frontend><span class=td-sidebar-nav-active-item>2.1. Securing the frontend</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docskubernetes-basics02-secure-workload02_network-policies-li><a href=/docs/kubernetes-basics/02-secure-workload/02/_network-policies/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docskubernetes-basics02-secure-workload02_network-policies><span>2.2. Network Policies</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docskubernetes-basics03-security-architecture-li><a href=/docs/kubernetes-basics/03-security-architecture/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-docskubernetes-basics03-security-architecture><span>3. Security Architecture</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docskubernetes-basics03-security-architecture03_rbac-li><a href=/docs/kubernetes-basics/03-security-architecture/03/_rbac/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docskubernetes-basics03-security-architecture03_rbac><span>3.1. RBAC</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docskubernetes-basics03-security-architecture03_architecture-li><a href=/docs/kubernetes-basics/03-security-architecture/03/_architecture/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docskubernetes-basics03-security-architecture03_architecture><span>3.2. Architecture and encryption</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docskubernetes-basics03-security-architecture03_psa-li><a href=/docs/kubernetes-basics/03-security-architecture/03/_psa/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docskubernetes-basics03-security-architecture03_psa><span>3.3. PSA</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docskubernetes-basics03-security-architecture03_custom-policies-li><a href=/docs/kubernetes-basics/03-security-architecture/03/_custom-policies/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docskubernetes-basics03-security-architecture03_custom-policies><span>3.4. Custom Policies</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docskubernetes-basics03-security-architecture03_runtime-sec-li><a href=/docs/kubernetes-basics/03-security-architecture/03/_runtime-sec/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docskubernetes-basics03-security-architecture03_runtime-sec><span>3.5. Runtime Security</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docskubernetes-basics03-security-architecture03rbac-solution-li><a href=/docs/kubernetes-basics/03-security-architecture/03/rbac-solution/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docskubernetes-basics03-security-architecture03rbac-solution><span>3.6.</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docskubernetes-basics03-security-architecturemount-secrets-li><a href=/docs/kubernetes-basics/03-security-architecture/mount-secrets/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docskubernetes-basics03-security-architecturemount-secrets><span>3.7.</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docskubernetes-basics04-ctf-li><a href=/docs/kubernetes-basics/04-ctf/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-docskubernetes-basics04-ctf><span>4. CTF</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docskubernetes-basics04-ctf04_scen1-li><a href=/docs/kubernetes-basics/04-ctf/04/_scen1/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docskubernetes-basics04-ctf04_scen1><span>4.1. Scenario 1</span></a></li></ul></li></ul></li></ul></nav></div></aside><aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none"><div class="td-page-meta ms-2 pb-1 pt-2 mb-0"><a href=https://github.com/songlaa/kubernetes-security-training/tree/main/content/en/docs/kubernetes-basics/02-Secure-Workload/02/_sec-frontend.md class="td-page-meta--view td-page-meta__view" target=_blank rel=noopener><i class="fa-solid fa-file-lines fa-fw"></i> View page source</a>
<a href=https://github.com/songlaa/kubernetes-security-training/edit/main/content/en/docs/kubernetes-basics/02-Secure-Workload/02/_sec-frontend.md class="td-page-meta--edit td-page-meta__edit" target=_blank rel=noopener><i class="fa-solid fa-pen-to-square fa-fw"></i> Edit this page</a>
<a href="https://github.com/songlaa/kubernetes-security-training/new/main/content/en/docs/kubernetes-basics/02-Secure-Workload/02?filename=change-me.md&amp;value=---%0Atitle%3A+%22Long+Page+Title%22%0AlinkTitle%3A+%22Short+Nav+Title%22%0Aweight%3A+100%0Adescription%3A+%3E-%0A+++++Page+description+for+heading+and+indexes.%0A---%0A%0A%23%23+Heading%0A%0AEdit+this+template+to+create+your+new+page.%0A%0A%2A+Give+it+a+good+name%2C+ending+in+%60.md%60+-+e.g.+%60getting-started.md%60%0A%2A+Edit+the+%22front+matter%22+section+at+the+top+of+the+page+%28weight+controls+how+its+ordered+amongst+other+pages+in+the+same+directory%3B+lowest+number+first%29.%0A%2A+Add+a+good+commit+message+at+the+bottom+of+the+page+%28%3C80+characters%3B+use+the+extended+description+field+for+more+detail%29.%0A%2A+Create+a+new+branch+so+you+can+preview+your+new+file+and+request+a+review+via+Pull+Request.%0A" class="td-page-meta--child td-page-meta__child" target=_blank rel=noopener><i class="fa-solid fa-pen-to-square fa-fw"></i> Create child page</a>
<a href="https://github.com/songlaa/kubernetes-security-training/issues/new?title=Securing%20the%20frontend" class="td-page-meta--issue td-page-meta__issue" target=_blank rel=noopener><i class="fa-solid fa-list-check fa-fw"></i> Create documentation issue</a></div><div class=td-toc><nav id=TableOfContents><ul><li><a href=#task-211-security-context>Task 2.1.1: Security Context</a></li><li><a href=#task-212-a-more-secure-frontend>Task 2.1.2: A more secure frontend</a></li><li><a href=#task-213-seccomp-profile>Task 2.1.3: Seccomp profile</a></li></ul></nav></div></aside><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><nav aria-label=breadcrumb class=td-breadcrumbs><ol class=breadcrumb><li class=breadcrumb-item><a href=/docs/>Labs</a></li><li class=breadcrumb-item><a href=/docs/kubernetes-basics/02-secure-workload/>Secure Workload</a></li><li class="breadcrumb-item active" aria-current=page>Securing the frontend</li></ol></nav><div class=td-content><h1>2.1. Securing the frontend</h1><header class=article-meta></header><p>Right now we have a fully functioning application, but we want to run it as securely as possible. In Docker, we would make sure to run as an unprivileged user, drop unnecessary capabilities and use a Mandatory Access Control System like AppArmor. Let us apply that to Kubernetes!</p><p>In Kubernetes, the SecurityContext defines security-related settings for both Pods and individual Containers. It allows you to control various security aspects of your workloads, such as user permissions, capabilities, and Linux security features (like SELinux, AppArmor, and seccomp).</p><h2 id=task-211-security-context>Task 2.1.1: Security Context</h2><p>Before we secure our secure our frontend we have a general example of a security context in a pod:</p><p>Create a new file <code>security-context-demo.yaml</code> and paste the following content:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>kind: Pod
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: security-context-demo
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  securityContext:
</span></span><span style=display:flex><span>    runAsUser: <span style=color:#0000cf;font-weight:700>1000</span>
</span></span><span style=display:flex><span>    runAsGroup: <span style=color:#0000cf;font-weight:700>3000</span>
</span></span><span style=display:flex><span>    fsGroup: <span style=color:#0000cf;font-weight:700>2000</span>
</span></span><span style=display:flex><span>  volumes:
</span></span><span style=display:flex><span>  - name: sec-ctx-vol
</span></span><span style=display:flex><span>    emptyDir: <span style=color:#ce5c00;font-weight:700>{}</span>
</span></span><span style=display:flex><span>  containers:
</span></span><span style=display:flex><span>  - name: sec-ctx-demo
</span></span><span style=display:flex><span>    image: busybox:1.28
</span></span><span style=display:flex><span>    command: <span style=color:#ce5c00;font-weight:700>[</span> <span style=color:#4e9a06>&#34;sh&#34;</span>, <span style=color:#4e9a06>&#34;-c&#34;</span>, <span style=color:#4e9a06>&#34;sleep 1h&#34;</span> <span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span>    volumeMounts:
</span></span><span style=display:flex><span>    - name: sec-ctx-vol
</span></span><span style=display:flex><span>      mountPath: /data/demo
</span></span><span style=display:flex><span>    securityContext:
</span></span><span style=display:flex><span>      allowPrivilegeEscalation: <span style=color:#204a87>false</span>
</span></span></code></pre></div><p>Then apply it:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl apply -f security-context-demo.yaml --namespace &lt;namespace&gt;
</span></span></code></pre></div><p>You can see the different value entries in the &lsquo;securityContext&rsquo; sections (on pod and container level), let&rsquo;s figure how what do they do. So create the pod and connect into the shell:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl <span style=color:#204a87>exec</span> -it security-context-demo --namespace &lt;namespace&gt; -- sh
</span></span></code></pre></div><p>In the container run &lsquo;ps&rsquo; to get a list of all running processes. The output shows, that the processes are running with the user 1000, which is the value from &lsquo;runAsUser&rsquo;:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ps
</span></span></code></pre></div><p>This should display something like this:</p><pre tabindex=0><code>PID   USER     TIME  COMMAND
    1 1000      0:00 sleep 1h
    7 1000      0:00 sh
   13 1000      0:00 ps
</code></pre><p>Now navigate to the directory &lsquo;/data&rsquo; and list the content.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>cd</span> /data
</span></span><span style=display:flex><span>ls -l
</span></span></code></pre></div><p>As you can see the &rsquo;emptyDir&rsquo; has been mounted with the group ID of 2000, which is the value of the &lsquo;fsGroup&rsquo; field.</p><pre tabindex=0><code>drwxrwsrwx 2 root 2000 4096 Oct  20 20:10 demo
</code></pre><p>Go into the dir &lsquo;demo&rsquo; and create a file:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>cd</span> demo
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> hello &gt; demofile
</span></span></code></pre></div><p>List the content with &rsquo;ls -l&rsquo; again and see, that &lsquo;demofile&rsquo; has the group ID 2000, which is the value &lsquo;fsGroup&rsquo; as well.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ls -l 
</span></span></code></pre></div><p>At last run &lsquo;id&rsquo; here and check the output:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>id
</span></span></code></pre></div><pre tabindex=0><code>uid=1000 gid=3000 groups=2000
</code></pre><p>The shown group ID of the user is 3000, from the field &lsquo;runAsGroup&rsquo;. If the field is empty the user would have 0 (root) and every process would be able to go with files that are owned by the root (0) group.</p><p>Time to exit:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>exit</span>
</span></span></code></pre></div><p>&mldr;and discard the pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl delete pod security-context-demo --namespace &lt;namespace&gt;
</span></span></code></pre></div><p>We are ready to apply some of this new knowledge to our frontend deployment now:</p><h2 id=task-212-a-more-secure-frontend>Task 2.1.2: A more secure frontend</h2><p>First let us check if the current frontend runs as the root user, an easy way is to execute <code>whoami</code> in the running container:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl -n &lt;namespace&gt; <span style=color:#204a87>exec</span> deployments/example-frontend -- whoami
</span></span></code></pre></div><p>We see that the process is running with the user <code>web</code>. We could also have checked the Dockerfile or run <code>docker inspect</code> to get the user.</p><p>Now let us make sure we don&rsquo;t run this pod as root, even if the image would change. We can set the <code>runAsNonRoot</code> field to <code>true</code> in the securityContext. This ensures that the container will not run with root privileges. If the image being used has no specific user set, this will result in an error. For this example, we don&rsquo;t need <code>runAsUser</code> or <code>runAsGroup</code> because the image already runs with an unprivileged user/group.</p><p>We could also use <code>fsGroup</code> like in the example above. But since we don&rsquo;t use shared storage there is a better option: we add <code>readOnlyRootFilesystem</code> to the security context, this makes the filesystems in our container read-only.</p><p>Finally, we drop all capabilities of the container, since we run on a port that is >1024 we even don&rsquo;t need any capability to open lower ports.</p><p>Change your file <code>deployment_example-frontend.yaml</code> to incorporate this securityContext:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>apiVersion: apps/v1
</span></span><span style=display:flex><span>kind: Deployment
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  labels:
</span></span><span style=display:flex><span>    app: example-frontend
</span></span><span style=display:flex><span>  name: example-frontend
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  replicas: <span style=color:#0000cf;font-weight:700>2</span>
</span></span><span style=display:flex><span>  selector:
</span></span><span style=display:flex><span>    matchLabels:
</span></span><span style=display:flex><span>      app: example-frontend
</span></span><span style=display:flex><span>  strategy:
</span></span><span style=display:flex><span>    rollingUpdate:
</span></span><span style=display:flex><span>      maxSurge: 25%
</span></span><span style=display:flex><span>      maxUnavailable: <span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span>    type: RollingUpdate
</span></span><span style=display:flex><span>  template:
</span></span><span style=display:flex><span>    metadata:
</span></span><span style=display:flex><span>      labels:
</span></span><span style=display:flex><span>        app: example-frontend
</span></span><span style=display:flex><span>    spec:
</span></span><span style=display:flex><span>      securityContext:
</span></span><span style=display:flex><span>        runAsNonRoot: <span style=color:#204a87>true</span> 
</span></span><span style=display:flex><span>      containers:
</span></span><span style=display:flex><span>        - image: quay.io/acend/example-web-python:latest
</span></span><span style=display:flex><span>          name: example-frontend
</span></span><span style=display:flex><span>          securityContext:
</span></span><span style=display:flex><span>            readOnlyRootFilesystem: <span style=color:#204a87>true</span>
</span></span><span style=display:flex><span>            allowPrivilegeEscalation: <span style=color:#204a87>false</span>
</span></span><span style=display:flex><span>            capabilities:
</span></span><span style=display:flex><span>              drop:
</span></span><span style=display:flex><span>              - ALL
</span></span><span style=display:flex><span>          readinessProbe:
</span></span><span style=display:flex><span>            httpGet:
</span></span><span style=display:flex><span>              path: /health
</span></span><span style=display:flex><span>              port: <span style=color:#0000cf;font-weight:700>5000</span>
</span></span><span style=display:flex><span>              scheme: HTTP
</span></span><span style=display:flex><span>            initialDelaySeconds: <span style=color:#0000cf;font-weight:700>10</span>
</span></span><span style=display:flex><span>            timeoutSeconds: <span style=color:#0000cf;font-weight:700>1</span>
</span></span><span style=display:flex><span>          resources:
</span></span><span style=display:flex><span>            limits:
</span></span><span style=display:flex><span>              cpu: 100m
</span></span><span style=display:flex><span>              memory: 128Mi
</span></span><span style=display:flex><span>            requests:
</span></span><span style=display:flex><span>              cpu: 50m
</span></span><span style=display:flex><span>              memory: 128Mi
</span></span></code></pre></div><p>and apply it using:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl apply -f deployment_example-frontend.yaml --namespace &lt;namespace&gt;
</span></span></code></pre></div><p>Like this we can make sure that we don&rsquo;t run any container in our deployment as root, have minimum capabilites a read-only file system.</p><div class="alert alert-info" role=alert><h4 class=alert-heading>Note</h4>If you need to run as root but want the added security of user-namespaces, Kubernetes has them introduced recently as a beta feature. More information under <a href=https://kubernetes.io/docs/concepts/workloads/pods/user-namespaces/ target=_blank rel=noopener>https://kubernetes.io/docs/concepts/workloads/pods/user-namespaces/</a></div><p>If you looked closely at the example you might have spotted <code>allowPrivilegeEscalation</code> set to <code>false</code> for the container. This controls whether a process can gain additional privileges (e.g., by using setuid binaries). By default, this is true unless overridden, but it&rsquo;s recommended to set it to false to prevent privilege escalation, so we did that too.</p><h2 id=task-213-seccomp-profile>Task 2.1.3: Seccomp profile</h2><p>The default seccomp profiles for containers in Kubernetes depend on the underlying container runtime (Docker, containerd, CRI-O) and the Kubernetes distribution itself. Most distributions use the RuntimeDefault profile provided by the container runtime, but the actual system call restrictions may differ slightly based on the runtime’s configuration. Most container runtimes provide a sane set of default syscalls that are allowed or not.</p><p>You could adopt these defaults for your workload by setting the seccomp type in the security context of a pod or container to RuntimeDefault:</p><pre tabindex=0><code>spec:
  securityContext:
    seccompProfile:
      type: RuntimeDefault
</code></pre><p>If you have the seccompDefault configuration <a href=https://kubernetes.io/docs/tutorials/security/seccomp/#enable-the-use-of-runtimedefault-as-the-default-seccomp-profile-for-all-workloads target=_blank rel=noopener>enabled</a>
, then Pods use the RuntimeDefault seccomp profile whenever no other seccomp profile is specified. Otherwise, the default is Unconfined.</p><p>You could also create your own seccomp profile store it on the nodes and add it to security context of a pod like this:</p><pre tabindex=0><code>        securityContext:
            seccompProfile:
              type: Localhost
              localhostProfile: &#34;/path/to/custom-seccomp.json&#34;
</code></pre><p>We could use stricter seccomp profiles for certain pods or log the usage of certain syscalls in our environment like this.</p><p>Task 1.2.4: (Advanced) Secure the pod with two containers</p><p>Remember the Pod with 2 containers from previous tasks? Does it need all capabilities and root rights? Please add the necessary security context to it and see if it still runs and you can call the nginx container from the curl container through localhost.</p><div class="text-muted mt-5 pt-3"><div class=row><div class=col-sm><a href=/docs/kubernetes-basics/02-secure-workload/ data-toggle=tooltip title="Secure Workload"><i class="fa fa-arrow-circle-left"></i> Previous</a></div><div class="col-sm text-right"><a href=/docs/kubernetes-basics/02-secure-workload/02/_network-policies/ data-toggle=tooltip title="Network Policies">Next <i class="fa fa-arrow-circle-right"></i></a></div></div></div><div class=td-page-meta__lastmod>Last modified November 5, 2024: <a href=https://github.com/songlaa/kubernetes-security-training/commit/ff04d4f08fa7011dd8a350f3af248c95b0d70f5f>add advanced lab kyverno and sec context (ff04d4f)</a></div></div></main></div></div><footer class="td-footer row d-print-none"><div class=container-fluid><div class="row mx-md-2"><div class="td-footer__left col-6 col-sm-4 order-sm-1"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=LinkedIn aria-label=LinkedIn><a target=_blank rel=noopener href=https://linkedin.com/gabriel-graf-6b6446319/ aria-label=LinkedIn><i class="fab fa-linkedin-in"></i></a></li></ul></div><div class="td-footer__right col-6 col-sm-4 order-sm-3"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=GitHub aria-label=GitHub><a target=_blank rel=noopener href=https://github.com/songlaa/kubernetes-security-training aria-label=GitHub><i class="fab fa-github"></i></a></li></ul></div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2"><span class=td-footer__copyright>&copy;
2024
<span class=td-footer__authors>songlaa gmbh</span></span><span class=td-footer__all_rights_reserved>All Rights Reserved</span></div></div></div></footer></div><script src=/js/main.min.d05ad35ff2c6dc165933414181dc1f183f98fc42e97d00f21d8d3d73d13ab4e1.js integrity="sha256-0FrTX/LG3BZZM0FBgdwfGD+Y/ELpfQDyHY09c9E6tOE=" crossorigin=anonymous></script><script defer src=/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js integrity="sha256-c0eKfUgHaYrtfjVesj+YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin=anonymous></script><script src=/js/tabpane-persist.js></script><script src=/js/site.min.f234c71c91fb8841ef090eff193dd6c3ef1a5a351461c0aa2e63a9cea23babc2.js integrity="sha256-8jTHHJH7iEHvCQ7/GT3Ww+8aWjUUYcCqLmOpzqI7q8I=" crossorigin=anonymous></script></body></html>