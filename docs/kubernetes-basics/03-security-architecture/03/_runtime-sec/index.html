<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Runtime Security | Kubernetes Security Training</title>
<meta name=description content="Kubernetes clusters are dynamic, with workloads constantly being scheduled, modified, and removed. While static security measures (e.g., image scanning, Pod Security Policies) focus on vulnerabilities before deployment, runtime security tools like Falco detect threats as they occur.
This includes:
Detecting anomalous behavior (e.g., unexpected process executions in containers). Identifying suspicious network activity (e.g., unexpected connections or port scans). Tracking system calls for unauthorized actions (e.g., privilege escalation attempts). Falco is an open-source Kubernetes threat detection engine."><meta property="og:title" content="Runtime Security"><meta property="og:description" content="Kubernetes clusters are dynamic, with workloads constantly being scheduled, modified, and removed. While static security measures (e.g., image scanning, Pod Security Policies) focus on vulnerabilities before deployment, runtime security tools like Falco detect threats as they occur.
This includes:
Detecting anomalous behavior (e.g., unexpected process executions in containers). Identifying suspicious network activity (e.g., unexpected connections or port scans). Tracking system calls for unauthorized actions (e.g., privilege escalation attempts). Falco is an open-source Kubernetes threat detection engine."><meta property="og:type" content="article"><meta property="og:url" content="/docs/kubernetes-basics/03-security-architecture/03/_runtime-sec/"><meta property="article:section" content="docs"><meta property="article:modified_time" content="2024-11-01T09:37:09+01:00"><meta itemprop=name content="Runtime Security"><meta itemprop=description content="Kubernetes clusters are dynamic, with workloads constantly being scheduled, modified, and removed. While static security measures (e.g., image scanning, Pod Security Policies) focus on vulnerabilities before deployment, runtime security tools like Falco detect threats as they occur.
This includes:
Detecting anomalous behavior (e.g., unexpected process executions in containers). Identifying suspicious network activity (e.g., unexpected connections or port scans). Tracking system calls for unauthorized actions (e.g., privilege escalation attempts). Falco is an open-source Kubernetes threat detection engine."><meta itemprop=dateModified content="2024-11-01T09:37:09+01:00"><meta itemprop=wordCount content="742"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="Runtime Security"><meta name=twitter:description content="Kubernetes clusters are dynamic, with workloads constantly being scheduled, modified, and removed. While static security measures (e.g., image scanning, Pod Security Policies) focus on vulnerabilities before deployment, runtime security tools like Falco detect threats as they occur.
This includes:
Detecting anomalous behavior (e.g., unexpected process executions in containers). Identifying suspicious network activity (e.g., unexpected connections or port scans). Tracking system calls for unauthorized actions (e.g., privilege escalation attempts). Falco is an open-source Kubernetes threat detection engine."><link rel=preload href=/scss/main.min.a640f285742d63fc54f2d0a8831ec7331ffac626070575a64961fc7e06c1bf34.css as=style><link href=/scss/main.min.a640f285742d63fc54f2d0a8831ec7331ffac626070575a64961fc7e06c1bf34.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.7.1.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous></script></head><body class=td-page><header><nav class="td-navbar js-navbar-scroll" data-bs-theme=dark><div class="container-fluid flex-column flex-md-row"><a class=navbar-brand href=/><span class="navbar-brand__logo navbar-logo"></span><span class=navbar-brand__name>Kubernetes Security Training</span></a><div class="td-navbar-nav-scroll ms-md-auto" id=main_navbar><ul class=navbar-nav><li class=nav-item><a class=nav-link href=/setup/><span>Setup</span></a></li><li class=nav-item><a class=nav-link href=/slides/><span>Slides</span></a></li><li class=nav-item><a class=nav-link href=https://songlaa.com target=_blank rel=noopener><span>songlaa gmbh</span></a></li></ul></div><div class="d-none d-lg-block"></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><form class="td-sidebar__search d-flex align-items-center"><button class="btn btn-link td-sidebar__toggle d-md-none p-0 ms-3 fas fa-bars" type=button data-bs-toggle=collapse data-bs-target=#td-section-nav aria-controls=td-section-nav aria-expanded=false aria-label="Toggle section navigation"></button></form><nav class="td-sidebar-nav collapse" id=td-section-nav><ul class="td-sidebar-nav__section pe-md-3 ul-0"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-docs-li><a href=/docs/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-docs><span>Labs</span></a><ul class=ul-1><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docskubernetes-basics01-basics-li><a href=/docs/kubernetes-basics/01-basics/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-docskubernetes-basics01-basics><span>1. Basics</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docskubernetes-basics01-basics01_introduction-li><a href=/docs/kubernetes-basics/01-basics/01/_introduction/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docskubernetes-basics01-basics01_introduction><span>1.1. Introduction</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docskubernetes-basics01-basics01_deployments-li><a href=/docs/kubernetes-basics/01-basics/01/_deployments/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docskubernetes-basics01-basics01_deployments><span>1.2. Deployments</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docskubernetes-basics01-basics01_service-li><a href=/docs/kubernetes-basics/01-basics/01/_service/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docskubernetes-basics01-basics01_service><span>1.3. Exposing a Service</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docskubernetes-basics01-basics01_database-li><a href=/docs/kubernetes-basics/01-basics/01/_database/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docskubernetes-basics01-basics01_database><span>1.4. Backend</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docskubernetes-basics02-secure-workload-li><a href=/docs/kubernetes-basics/02-secure-workload/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-docskubernetes-basics02-secure-workload><span>2. Secure Workload</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docskubernetes-basics02-secure-workload02_sec-frontend-li><a href=/docs/kubernetes-basics/02-secure-workload/02/_sec-frontend/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docskubernetes-basics02-secure-workload02_sec-frontend><span>2.1. Securing the frontend</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docskubernetes-basics02-secure-workload02_network-policies-li><a href=/docs/kubernetes-basics/02-secure-workload/02/_network-policies/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docskubernetes-basics02-secure-workload02_network-policies><span>2.2. Network Policies</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-docskubernetes-basics03-security-architecture-li><a href=/docs/kubernetes-basics/03-security-architecture/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-docskubernetes-basics03-security-architecture><span>3. Security Architecture</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docskubernetes-basics03-security-architecture03_rbac-li><a href=/docs/kubernetes-basics/03-security-architecture/03/_rbac/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docskubernetes-basics03-security-architecture03_rbac><span>3.1. RBAC</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docskubernetes-basics03-security-architecture03_architecture-li><a href=/docs/kubernetes-basics/03-security-architecture/03/_architecture/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docskubernetes-basics03-security-architecture03_architecture><span>3.2. Architecture and encryption</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docskubernetes-basics03-security-architecture03_psa-li><a href=/docs/kubernetes-basics/03-security-architecture/03/_psa/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docskubernetes-basics03-security-architecture03_psa><span>3.3. PSA</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docskubernetes-basics03-security-architecture03_custom-policies-li><a href=/docs/kubernetes-basics/03-security-architecture/03/_custom-policies/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docskubernetes-basics03-security-architecture03_custom-policies><span>3.4. Custom Policies</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id=m-docskubernetes-basics03-security-architecture03_runtime-sec-li><a href=/docs/kubernetes-basics/03-security-architecture/03/_runtime-sec/ class="align-left ps-0 active td-sidebar-link td-sidebar-link__page" id=m-docskubernetes-basics03-security-architecture03_runtime-sec><span class=td-sidebar-nav-active-item>3.5. Runtime Security</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docskubernetes-basics04-ctf-li><a href=/docs/kubernetes-basics/04-ctf/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-docskubernetes-basics04-ctf><span>4. CTF</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docskubernetes-basics04-ctf04_scen1-li><a href=/docs/kubernetes-basics/04-ctf/04/_scen1/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docskubernetes-basics04-ctf04_scen1><span>4.1. Scenario 1</span></a></li></ul></li></ul></li></ul></nav></div></aside><aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none"><div class="td-page-meta ms-2 pb-1 pt-2 mb-0"><a href=https://github.com/songlaa/kubernetes-security-training/tree/main/content/en/docs/kubernetes-basics/03-Security-Architecture/03/_runtime-sec.md class="td-page-meta--view td-page-meta__view" target=_blank rel=noopener><i class="fa-solid fa-file-lines fa-fw"></i> View page source</a>
<a href=https://github.com/songlaa/kubernetes-security-training/edit/main/content/en/docs/kubernetes-basics/03-Security-Architecture/03/_runtime-sec.md class="td-page-meta--edit td-page-meta__edit" target=_blank rel=noopener><i class="fa-solid fa-pen-to-square fa-fw"></i> Edit this page</a>
<a href="https://github.com/songlaa/kubernetes-security-training/new/main/content/en/docs/kubernetes-basics/03-Security-Architecture/03?filename=change-me.md&amp;value=---%0Atitle%3A+%22Long+Page+Title%22%0AlinkTitle%3A+%22Short+Nav+Title%22%0Aweight%3A+100%0Adescription%3A+%3E-%0A+++++Page+description+for+heading+and+indexes.%0A---%0A%0A%23%23+Heading%0A%0AEdit+this+template+to+create+your+new+page.%0A%0A%2A+Give+it+a+good+name%2C+ending+in+%60.md%60+-+e.g.+%60getting-started.md%60%0A%2A+Edit+the+%22front+matter%22+section+at+the+top+of+the+page+%28weight+controls+how+its+ordered+amongst+other+pages+in+the+same+directory%3B+lowest+number+first%29.%0A%2A+Add+a+good+commit+message+at+the+bottom+of+the+page+%28%3C80+characters%3B+use+the+extended+description+field+for+more+detail%29.%0A%2A+Create+a+new+branch+so+you+can+preview+your+new+file+and+request+a+review+via+Pull+Request.%0A" class="td-page-meta--child td-page-meta__child" target=_blank rel=noopener><i class="fa-solid fa-pen-to-square fa-fw"></i> Create child page</a>
<a href="https://github.com/songlaa/kubernetes-security-training/issues/new?title=Runtime%20Security" class="td-page-meta--issue td-page-meta__issue" target=_blank rel=noopener><i class="fa-solid fa-list-check fa-fw"></i> Create documentation issue</a></div><div class=td-toc><nav id=TableOfContents><ul><li><ul><li><a href=#task-351-install-falco-on-kind>Task 3.5.1: Install Falco on kind</a></li></ul></li></ul></nav></div></aside><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><nav aria-label=breadcrumb class=td-breadcrumbs><ol class=breadcrumb><li class=breadcrumb-item><a href=/docs/>Labs</a></li><li class=breadcrumb-item><a href=/docs/kubernetes-basics/03-security-architecture/>Security Architecture</a></li><li class="breadcrumb-item active" aria-current=page>Runtime Security</li></ol></nav><div class=td-content><h1>3.5. Runtime Security</h1><header class=article-meta></header><p>Kubernetes clusters are dynamic, with workloads constantly being scheduled, modified, and removed. While static security measures (e.g., image scanning, Pod Security Policies) focus on vulnerabilities before deployment, runtime security tools like Falco detect threats as they occur.</p><p>This includes:</p><ul><li>Detecting anomalous behavior (e.g., unexpected process executions in containers).</li><li>Identifying suspicious network activity (e.g., unexpected connections or port scans).</li><li>Tracking system calls for unauthorized actions (e.g., privilege escalation attempts).</li></ul><p>Falco is an open-source Kubernetes threat detection engine. It detects unexpected application behavior and alerts on threats at runtime. At the core of Falco is its driver responsible for monitoring (container) syscalls and forwarding them to userspace for analysis.</p><h3 id=task-351-install-falco-on-kind>Task 3.5.1: Install Falco on kind</h3><p>First, install the helm repository (exit the kind docker container if you are still in it from the previous lab):</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>helm repo add falcosecurity https://falcosecurity.github.io/charts
</span></span><span style=display:flex><span>helm repo update
</span></span></code></pre></div><p>Then install Falco:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>helm install --replace falco --namespace falco --create-namespace --set <span style=color:#000>tty</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span> falcosecurity/falco
</span></span></code></pre></div><p>And check that the Falco pods are running:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl get pods -n falco
</span></span></code></pre></div><p>Falco pod(s) might need a bit to start. Wait until they are ready:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl <span style=color:#204a87>wait</span> pods --for<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>condition</span><span style=color:#ce5c00;font-weight:700>=</span>Ready --all -n falco
</span></span></code></pre></div><p>Falco comes with a <a href=https://github.com/falcosecurity/rules/blob/main/rules/falco_rules.yaml target=_blank rel=noopener>pre-installed set of rules</a>
that alert you upon suspicious behavior. We can check this by triggering such a rule.</p><p>One of these default rules is a log entry every time a shell is opened in a pod, let us do that:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl <span style=color:#204a87>exec</span> -it -n test-kyverno alpine-pod -- sh 
</span></span></code></pre></div><p>Now let&rsquo;s take a look at the Falco logs:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl logs -l app.kubernetes.io/name<span style=color:#ce5c00;font-weight:700>=</span>falco -n falco -c falco <span style=color:#000;font-weight:700>|</span> grep <span style=color:#4e9a06>&#34;shell was spawned&#34;</span>
</span></span></code></pre></div><p>You will see logs for all the Falco pods deployed on the system. The Falco pod corresponding to the node in which our <code>alpine-pod</code> is running has detected the event, and you&rsquo;ll be able to read a line like:</p><pre tabindex=0><code>09:13:33.058953225: Notice A shell was spawned in a container with an attached terminal (evt_type=execve user=root user_uid=1000 user_loginuid=-1 process=sh proc_exepath=/bin/busybox parent=containerd-shim command=sh terminal=34816 exe_flags=EXE_LOWER_LAYER container_id=198e59c8bb67 container_image=docker.io/library/alpine container_image_tag=latest container_name=alpine k8s_ns=test-kyverno k8s_pod_name=alpine-pod)
</code></pre><p>We could forward the logs of the Falco daemonset to a central instance and alert on certain events there.</p><p>In a previous chapter we mentioned, that it is possible to read secrets by executing a pod and mounting the secret. This is exactly a situation where we can use a runtime security tool like Falco. Let us demonstrate that:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#create the cert</span>
</span></span><span style=display:flex><span>openssl req -new -newkey rsa:4096 -x509 -sha256 -days <span style=color:#0000cf;font-weight:700>365</span> -nodes -subj <span style=color:#4e9a06>&#34;/C=CH/O=songlaa/OU=Domain Control Validated/CN=*.songlaa.com&#34;</span> -out tls.crt -keyout tls.key
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#create the secret from the cert</span>
</span></span><span style=display:flex><span>kubectl create secret tls nginx-tls --cert<span style=color:#ce5c00;font-weight:700>=</span>tls.crt --key<span style=color:#ce5c00;font-weight:700>=</span>tls.key
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># create the pod mounting the secret</span>
</span></span><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt; EOF &gt;&gt; secret-mount-pod.yaml
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Pod
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: nginx-tls-pod
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  securityContext:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    seccompProfile:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      type: RuntimeDefault
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  containers:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: nginx
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      image: bitnami/nginx
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      ports:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - containerPort: 8443
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      securityContext:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        allowPrivilegeEscalation: false
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        readOnlyRootFilesystem: false
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        runAsNonRoot: true
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        runAsUser: 101
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        capabilities:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          drop: [&#34;ALL&#34;]
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        seccompProfile:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          type: RuntimeDefault
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      volumeMounts:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - name: tls-cert
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          mountPath: &#34;/etc/nginx/tls&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          readOnly: true
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  volumes:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: tls-cert
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      secret:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        secretName: nginx-tls
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span><span style=display:flex><span>kubectl apply -f secret-mount-pod.yaml
</span></span></code></pre></div><p>You created a webserver which uses a certificate from a secret to encrypt its communication. Now, let’s create a Falco rule that triggers an alert if any process other than nginx accesses the mounted secret files (the certificate and private key).</p><p>Create a yaml named <code>falco_custom_rules_cm.yaml</code> with your custom rule:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>cat &lt;&lt; \EOF &gt;&gt; falco_custom_rules_cm.yaml</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>customRules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>custom-rules.yaml</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>|-</span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    - rule: Unauthorized Access to Nginx TLS Secrets
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      desc: Detects when a process other than nginx accesses the mounted TLS secrets
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      condition: open_read and container and (fd.name startswith &#34;/etc/nginx/tls&#34;) and (proc.name != &#34;nginx&#34;)
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      output: &#34;Unauthorized access to TLS secret by process other than nginx (user=%user.name command=%proc.cmdline file=%fd.name container=%container.name)&#34;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      priority: WARNING
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      tags: [kubernetes, secrets, tls, nginx]</span><span style=color:#f8f8f8;text-decoration:underline>    
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>EOF</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>This rule triggers on any read access (open_read) to files under /etc/nginx/tls (where the TLS cert and key are mounted).
It excludes nginx processes by checking that proc.name != &ldquo;nginx&rdquo;.
The output logs the offending process and the file accessed.</p><p>And load it into Falco:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>helm upgrade --namespace falco falco falcosecurity/falco --set <span style=color:#000>tty</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span> -f falco_custom_rules_cm.yaml
</span></span></code></pre></div><p>Falco pods need some time to restart. Wait until they are ready:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl <span style=color:#204a87>wait</span> pods --for<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>condition</span><span style=color:#ce5c00;font-weight:700>=</span>Ready --all -n falco
</span></span></code></pre></div><p>Then trigger our new rule:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl <span style=color:#204a87>exec</span> -it nginx-tls-pod -- cat /etc/nginx/tls/tls.key
</span></span></code></pre></div><p>And again check the logs:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl logs -l app.kubernetes.io/name<span style=color:#ce5c00;font-weight:700>=</span>falco -n falco -c falco <span style=color:#000;font-weight:700>|</span> grep nginx
</span></span></code></pre></div><p>We saw that we can create alerts for different use cases. The Falco default ruleset is just a start you need to create rules according to your own needs and requirements in your cluster.</p><div class="text-muted mt-5 pt-3"><div class=row><div class=col-sm><a href=/docs/kubernetes-basics/03-security-architecture/03/_custom-policies/ data-toggle=tooltip title="Custom Policies"><i class="fa fa-arrow-circle-left"></i> Previous</a></div><div class="col-sm text-right"><a href=/docs/kubernetes-basics/04-ctf/ data-toggle=tooltip title=CTF>Next <i class="fa fa-arrow-circle-right"></i></a></div></div></div><div class=td-page-meta__lastmod>Last modified November 1, 2024: <a href=https://github.com/songlaa/kubernetes-security-training/commit/0e761c52634f411188426afdb7245b4ebe8c6172>fix grammar an typos in all labs (0e761c5)</a></div></div></main></div></div><footer class="td-footer row d-print-none"><div class=container-fluid><div class="row mx-md-2"><div class="td-footer__left col-6 col-sm-4 order-sm-1"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=LinkedIn aria-label=LinkedIn><a target=_blank rel=noopener href=https://linkedin.com/gabriel-graf-6b6446319/ aria-label=LinkedIn><i class="fab fa-linkedin-in"></i></a></li></ul></div><div class="td-footer__right col-6 col-sm-4 order-sm-3"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=GitHub aria-label=GitHub><a target=_blank rel=noopener href=https://github.com/songlaa/kubernetes-security-training aria-label=GitHub><i class="fab fa-github"></i></a></li></ul></div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2"><span class=td-footer__copyright>&copy;
2024
<span class=td-footer__authors>songlaa gmbh</span></span><span class=td-footer__all_rights_reserved>All Rights Reserved</span></div></div></div></footer></div><script src=/js/main.min.d05ad35ff2c6dc165933414181dc1f183f98fc42e97d00f21d8d3d73d13ab4e1.js integrity="sha256-0FrTX/LG3BZZM0FBgdwfGD+Y/ELpfQDyHY09c9E6tOE=" crossorigin=anonymous></script><script defer src=/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js integrity="sha256-c0eKfUgHaYrtfjVesj+YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin=anonymous></script><script src=/js/tabpane-persist.js></script><script src=/js/site.min.f234c71c91fb8841ef090eff193dd6c3ef1a5a351461c0aa2e63a9cea23babc2.js integrity="sha256-8jTHHJH7iEHvCQ7/GT3Ww+8aWjUUYcCqLmOpzqI7q8I=" crossorigin=anonymous></script></body></html>