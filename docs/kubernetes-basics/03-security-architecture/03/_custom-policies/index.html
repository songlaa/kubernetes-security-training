<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Custom Policies | Kubernetes Security Training</title>
<meta name=description content="Until now we learned best practices on how to secure our workload in Kubernetes, but as a cluster admin. How can we enforce certain regulations for resources in our cluster? Sometimes we need to be more specific than the 3 PSP this is where policy engines like Open Policy Agent (OPA) or Kyverno come into play.
Kyverno Kyverno is an open-source policy engine designed specifically for Kubernetes. It allows you to manage and enforce security and compliance policies for your Kubernetes resources using custom resource definitions (CRDs)."><meta property="og:title" content="Custom Policies"><meta property="og:description" content="Until now we learned best practices on how to secure our workload in Kubernetes, but as a cluster admin. How can we enforce certain regulations for resources in our cluster? Sometimes we need to be more specific than the 3 PSP this is where policy engines like Open Policy Agent (OPA) or Kyverno come into play.
Kyverno Kyverno is an open-source policy engine designed specifically for Kubernetes. It allows you to manage and enforce security and compliance policies for your Kubernetes resources using custom resource definitions (CRDs)."><meta property="og:type" content="article"><meta property="og:url" content="/docs/kubernetes-basics/03-security-architecture/03/_custom-policies/"><meta property="article:section" content="docs"><meta property="article:modified_time" content="2024-11-01T09:37:09+01:00"><meta itemprop=name content="Custom Policies"><meta itemprop=description content="Until now we learned best practices on how to secure our workload in Kubernetes, but as a cluster admin. How can we enforce certain regulations for resources in our cluster? Sometimes we need to be more specific than the 3 PSP this is where policy engines like Open Policy Agent (OPA) or Kyverno come into play.
Kyverno Kyverno is an open-source policy engine designed specifically for Kubernetes. It allows you to manage and enforce security and compliance policies for your Kubernetes resources using custom resource definitions (CRDs)."><meta itemprop=dateModified content="2024-11-01T09:37:09+01:00"><meta itemprop=wordCount content="601"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="Custom Policies"><meta name=twitter:description content="Until now we learned best practices on how to secure our workload in Kubernetes, but as a cluster admin. How can we enforce certain regulations for resources in our cluster? Sometimes we need to be more specific than the 3 PSP this is where policy engines like Open Policy Agent (OPA) or Kyverno come into play.
Kyverno Kyverno is an open-source policy engine designed specifically for Kubernetes. It allows you to manage and enforce security and compliance policies for your Kubernetes resources using custom resource definitions (CRDs)."><link rel=preload href=/scss/main.min.a640f285742d63fc54f2d0a8831ec7331ffac626070575a64961fc7e06c1bf34.css as=style><link href=/scss/main.min.a640f285742d63fc54f2d0a8831ec7331ffac626070575a64961fc7e06c1bf34.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.7.1.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous></script></head><body class=td-page><header><nav class="td-navbar js-navbar-scroll" data-bs-theme=dark><div class="container-fluid flex-column flex-md-row"><a class=navbar-brand href=/><span class="navbar-brand__logo navbar-logo"></span><span class=navbar-brand__name>Kubernetes Security Training</span></a><div class="td-navbar-nav-scroll ms-md-auto" id=main_navbar><ul class=navbar-nav><li class=nav-item><a class=nav-link href=/setup/><span>Setup</span></a></li><li class=nav-item><a class=nav-link href=/slides/><span>Slides</span></a></li><li class=nav-item><a class=nav-link href=https://songlaa.com target=_blank rel=noopener><span>songlaa gmbh</span></a></li></ul></div><div class="d-none d-lg-block"></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><form class="td-sidebar__search d-flex align-items-center"><button class="btn btn-link td-sidebar__toggle d-md-none p-0 ms-3 fas fa-bars" type=button data-bs-toggle=collapse data-bs-target=#td-section-nav aria-controls=td-section-nav aria-expanded=false aria-label="Toggle section navigation"></button></form><nav class="td-sidebar-nav collapse" id=td-section-nav><ul class="td-sidebar-nav__section pe-md-3 ul-0"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-docs-li><a href=/docs/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-docs><span>Labs</span></a><ul class=ul-1><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docskubernetes-basics01-basics-li><a href=/docs/kubernetes-basics/01-basics/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-docskubernetes-basics01-basics><span>1. Basics</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docskubernetes-basics01-basics01_introduction-li><a href=/docs/kubernetes-basics/01-basics/01/_introduction/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docskubernetes-basics01-basics01_introduction><span>1.1. Introduction</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docskubernetes-basics01-basics01_deployments-li><a href=/docs/kubernetes-basics/01-basics/01/_deployments/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docskubernetes-basics01-basics01_deployments><span>1.2. Deployments</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docskubernetes-basics01-basics01_service-li><a href=/docs/kubernetes-basics/01-basics/01/_service/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docskubernetes-basics01-basics01_service><span>1.3. Exposing a Service</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docskubernetes-basics01-basics01_database-li><a href=/docs/kubernetes-basics/01-basics/01/_database/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docskubernetes-basics01-basics01_database><span>1.4. Backend</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docskubernetes-basics02-secure-workload-li><a href=/docs/kubernetes-basics/02-secure-workload/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-docskubernetes-basics02-secure-workload><span>2. Secure Workload</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docskubernetes-basics02-secure-workload02_sec-frontend-li><a href=/docs/kubernetes-basics/02-secure-workload/02/_sec-frontend/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docskubernetes-basics02-secure-workload02_sec-frontend><span>2.1. Securing the frontend</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docskubernetes-basics02-secure-workload02_network-policies-li><a href=/docs/kubernetes-basics/02-secure-workload/02/_network-policies/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docskubernetes-basics02-secure-workload02_network-policies><span>2.2. Network Policies</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-docskubernetes-basics03-security-architecture-li><a href=/docs/kubernetes-basics/03-security-architecture/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-docskubernetes-basics03-security-architecture><span>3. Security Architecture</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docskubernetes-basics03-security-architecture03_rbac-li><a href=/docs/kubernetes-basics/03-security-architecture/03/_rbac/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docskubernetes-basics03-security-architecture03_rbac><span>3.1. RBAC</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docskubernetes-basics03-security-architecture03_architecture-li><a href=/docs/kubernetes-basics/03-security-architecture/03/_architecture/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docskubernetes-basics03-security-architecture03_architecture><span>3.2. Architecture and encryption</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docskubernetes-basics03-security-architecture03_psa-li><a href=/docs/kubernetes-basics/03-security-architecture/03/_psa/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docskubernetes-basics03-security-architecture03_psa><span>3.3. PSA</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id=m-docskubernetes-basics03-security-architecture03_custom-policies-li><a href=/docs/kubernetes-basics/03-security-architecture/03/_custom-policies/ class="align-left ps-0 active td-sidebar-link td-sidebar-link__page" id=m-docskubernetes-basics03-security-architecture03_custom-policies><span class=td-sidebar-nav-active-item>3.4. Custom Policies</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docskubernetes-basics03-security-architecture03_runtime-sec-li><a href=/docs/kubernetes-basics/03-security-architecture/03/_runtime-sec/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docskubernetes-basics03-security-architecture03_runtime-sec><span>3.5. Runtime Security</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docskubernetes-basics04-ctf-li><a href=/docs/kubernetes-basics/04-ctf/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-docskubernetes-basics04-ctf><span>4. CTF</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docskubernetes-basics04-ctf04_scen1-li><a href=/docs/kubernetes-basics/04-ctf/04/_scen1/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docskubernetes-basics04-ctf04_scen1><span>4.1. Scenario 1</span></a></li></ul></li></ul></li></ul></nav></div></aside><aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none"><div class="td-page-meta ms-2 pb-1 pt-2 mb-0"><a href=https://github.com/songlaa/kubernetes-security-training/tree/main/content/en/docs/kubernetes-basics/03-Security-Architecture/03/_custom-policies.md class="td-page-meta--view td-page-meta__view" target=_blank rel=noopener><i class="fa-solid fa-file-lines fa-fw"></i> View page source</a>
<a href=https://github.com/songlaa/kubernetes-security-training/edit/main/content/en/docs/kubernetes-basics/03-Security-Architecture/03/_custom-policies.md class="td-page-meta--edit td-page-meta__edit" target=_blank rel=noopener><i class="fa-solid fa-pen-to-square fa-fw"></i> Edit this page</a>
<a href="https://github.com/songlaa/kubernetes-security-training/new/main/content/en/docs/kubernetes-basics/03-Security-Architecture/03?filename=change-me.md&amp;value=---%0Atitle%3A+%22Long+Page+Title%22%0AlinkTitle%3A+%22Short+Nav+Title%22%0Aweight%3A+100%0Adescription%3A+%3E-%0A+++++Page+description+for+heading+and+indexes.%0A---%0A%0A%23%23+Heading%0A%0AEdit+this+template+to+create+your+new+page.%0A%0A%2A+Give+it+a+good+name%2C+ending+in+%60.md%60+-+e.g.+%60getting-started.md%60%0A%2A+Edit+the+%22front+matter%22+section+at+the+top+of+the+page+%28weight+controls+how+its+ordered+amongst+other+pages+in+the+same+directory%3B+lowest+number+first%29.%0A%2A+Add+a+good+commit+message+at+the+bottom+of+the+page+%28%3C80+characters%3B+use+the+extended+description+field+for+more+detail%29.%0A%2A+Create+a+new+branch+so+you+can+preview+your+new+file+and+request+a+review+via+Pull+Request.%0A" class="td-page-meta--child td-page-meta__child" target=_blank rel=noopener><i class="fa-solid fa-pen-to-square fa-fw"></i> Create child page</a>
<a href="https://github.com/songlaa/kubernetes-security-training/issues/new?title=Custom%20Policies" class="td-page-meta--issue td-page-meta__issue" target=_blank rel=noopener><i class="fa-solid fa-list-check fa-fw"></i> Create documentation issue</a></div><div class=td-toc><nav id=TableOfContents><ul><li><a href=#kyverno>Kyverno</a><ul><li><a href=#task-341-install-kyverno-on-our-kind-cluster>Task 3.4.1: Install Kyverno on our kind cluster</a></li><li><a href=#task-342-apply-a-policy>Task 3.4.2: Apply a policy</a></li></ul></li></ul></nav></div></aside><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><nav aria-label=breadcrumb class=td-breadcrumbs><ol class=breadcrumb><li class=breadcrumb-item><a href=/docs/>Labs</a></li><li class=breadcrumb-item><a href=/docs/kubernetes-basics/03-security-architecture/>Security Architecture</a></li><li class="breadcrumb-item active" aria-current=page>Custom Policies</li></ol></nav><div class=td-content><h1>3.4. Custom Policies</h1><header class=article-meta></header><p>Until now we learned best practices on how to secure our workload in Kubernetes, but as a cluster admin. How can we enforce certain regulations for resources in our cluster? Sometimes we need to be more specific than the 3 PSP this is where policy engines like <a href=https://www.openpolicyagent.org/ target=_blank rel=noopener>Open Policy Agent (OPA)</a>
or <a href=https://kyverno.io/ target=_blank rel=noopener>Kyverno</a>
come into play.</p><h2 id=kyverno>Kyverno</h2><p>Kyverno is an open-source policy engine designed specifically for Kubernetes. It allows you to manage and enforce security and compliance policies for your Kubernetes resources using custom resource definitions (CRDs). We use it to write our own Policies as Code.</p><p>Remember when we did patch a namespace in a previous lab. Patching and allowing the users to change labels can have real security consequences because it allows users to change the behavior of algorithms like network policies which use labels to filter out resources. This is why a Policy was set in place that you could only change certain labels of a namespace.</p><h3 id=task-341-install-kyverno-on-our-kind-cluster>Task 3.4.1: Install Kyverno on our kind cluster</h3><p>We will install a standalone version of Kyverno on our <code>kind</code> cluster using helm to test out its functionality:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>helm repo add kyverno https://kyverno.github.io/kyverno/
</span></span><span style=display:flex><span>helm repo update
</span></span><span style=display:flex><span>helm install kyverno kyverno/kyverno -n kyverno --create-namespace
</span></span></code></pre></div><p>We see that a new Webhook was created which calls Kyverno on CREATE and UPDATE operations:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl get validatingwebhookconfigurations.admissionregistration.k8s.io kyverno-policy-validating-webhook-cfg -oyaml
</span></span></code></pre></div><p>Kyverno itself runs in the <code>kyverno</code> namespace:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl get deployments.apps -n kyverno
</span></span></code></pre></div><h3 id=task-342-apply-a-policy>Task 3.4.2: Apply a policy</h3><p>Let us create a namespace called <code>test-kyverno</code> and apply our own policy for this namespace, we want to start soft and warn users if they did not add the requirement that a container must drop <code>ALL</code> capabilities.</p><p>Create the namespace first:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl create ns test-kyverno
</span></span></code></pre></div><p>Now let us create a pod which passes the PSS Level <code>baseline</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF &gt;&gt; alpine-pod.yaml
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Pod
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: alpine-pod
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: test-kyverno
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  labels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    app: alpine
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  securityContext:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    runAsNonRoot: true
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    runAsUser: 1000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  containers:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: alpine
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      image: alpine
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      command: [&#34;sleep&#34;, &#34;infinity&#34;]
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      securityContext:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        allowPrivilegeEscalation: false
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        readOnlyRootFilesystem: true
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      resources:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        limits:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          cpu: &#34;100m&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          memory: &#34;128Mi&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span><span style=display:flex><span>kubectl apply -f alpine-pod.yaml
</span></span></code></pre></div><p>We see this works.</p><p>The baseline does not monitor if file systems are mounted <code>read-only</code> but the <code>restricted</code> profile is not flexibel enough. Let us apply a Kyverno policy for that.</p><p>Kyvernos has a so called Custom Resourced called policy for that, create a file named <code>read-only.yaml</code> with this content:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>cat &lt;&lt;\EOF &gt;&gt; read-only.yaml</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>kyverno.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Policy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>enforce-readonly-filesystem</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>test-kyverno</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>annotations</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>policies.kyverno.io/title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Enforce read-only fs</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>policies.kyverno.io/category</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Best Practices</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>policies.kyverno.io/severity</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>medium</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>policies.kyverno.io/minversion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1.6.0</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>policies.kyverno.io/subject</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Pod</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>validationFailureAction</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Audit</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>background</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>check-readonly-root-filesystem</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>match</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>resources</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>kinds</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span>- <span style=color:#000>Pod</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>validate</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>message</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;The root filesystem must be mounted as read-only for all containers.&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>pattern</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>containers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span>- <span style=color:#204a87;font-weight:700>securityContext</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                  </span><span style=color:#204a87;font-weight:700>readOnlyRootFilesystem</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>EOF</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>Apply the policy now</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl apply -f read-only.yaml
</span></span></code></pre></div><p>Now let us delete, edit and rerun the pod</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl delete -f alpine-pod.yaml
</span></span></code></pre></div><p>Switch <code>readOnlyRootFilesystem</code> to false.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>nano alpine-pod.yaml
</span></span></code></pre></div><p>And then apply the pod again:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl apply -f alpine-pod.yaml
</span></span></code></pre></div><p>Because the Action is only set to <code>Audit</code> noncompliant resources are only logged, check here:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl -n test-kyverno describe policies.kyverno.io enforce-readonly-filesystem
</span></span></code></pre></div><p>Let us now enforce our policy, switch the <code>Audit</code> to <code>Enforce</code> in <code>drop-policy.yaml</code> and apply it again:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>nano read-only.yaml
</span></span><span style=display:flex><span>kubectl apply -f read-only.yaml
</span></span></code></pre></div><p>Now test the same pod again:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl delete -f alpine-pod.yaml
</span></span><span style=display:flex><span>kubectl apply -f alpine-pod.yaml
</span></span></code></pre></div><p>We were successful in implementing and enforcing our policy for newly started pods. We still need this pod running so change it back to a working mode:</p><p>Let us now enforce our policy, switch the <code>Audit</code> to <code>Enforce</code> in <code>drop-policy.yaml</code> and apply it again:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>nano alpine-pod.yaml
</span></span><span style=display:flex><span>kubectl apply -f alpine-pod.yaml
</span></span></code></pre></div><div class="text-muted mt-5 pt-3"><div class=row><div class=col-sm><a href=/docs/kubernetes-basics/03-security-architecture/03/_psa/ data-toggle=tooltip title=PSA><i class="fa fa-arrow-circle-left"></i> Previous</a></div><div class="col-sm text-right"><a href=/docs/kubernetes-basics/03-security-architecture/03/_runtime-sec/ data-toggle=tooltip title="Runtime Security">Next <i class="fa fa-arrow-circle-right"></i></a></div></div></div><div class=td-page-meta__lastmod>Last modified November 1, 2024: <a href=https://github.com/songlaa/kubernetes-security-training/commit/0e761c52634f411188426afdb7245b4ebe8c6172>fix grammar an typos in all labs (0e761c5)</a></div></div></main></div></div><footer class="td-footer row d-print-none"><div class=container-fluid><div class="row mx-md-2"><div class="td-footer__left col-6 col-sm-4 order-sm-1"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=LinkedIn aria-label=LinkedIn><a target=_blank rel=noopener href=https://linkedin.com/gabriel-graf-6b6446319/ aria-label=LinkedIn><i class="fab fa-linkedin-in"></i></a></li></ul></div><div class="td-footer__right col-6 col-sm-4 order-sm-3"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=GitHub aria-label=GitHub><a target=_blank rel=noopener href=https://github.com/songlaa/kubernetes-security-training aria-label=GitHub><i class="fab fa-github"></i></a></li></ul></div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2"><span class=td-footer__copyright>&copy;
2024
<span class=td-footer__authors>songlaa gmbh</span></span><span class=td-footer__all_rights_reserved>All Rights Reserved</span></div></div></div></footer></div><script src=/js/main.min.d05ad35ff2c6dc165933414181dc1f183f98fc42e97d00f21d8d3d73d13ab4e1.js integrity="sha256-0FrTX/LG3BZZM0FBgdwfGD+Y/ELpfQDyHY09c9E6tOE=" crossorigin=anonymous></script><script defer src=/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js integrity="sha256-c0eKfUgHaYrtfjVesj+YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin=anonymous></script><script src=/js/tabpane-persist.js></script><script src=/js/site.min.f234c71c91fb8841ef090eff193dd6c3ef1a5a351461c0aa2e63a9cea23babc2.js integrity="sha256-8jTHHJH7iEHvCQ7/GT3Ww+8aWjUUYcCqLmOpzqI7q8I=" crossorigin=anonymous></script></body></html>