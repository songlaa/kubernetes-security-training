<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>RBAC | Kubernetes Security Training</title>
<meta name=description content="Role Based Access Control Until now we just assumed that we have the necessary right to do our tasks in kubernetes. But how are users Authenticated and Authorized in Kubernetes/the Kubernetes API?
Users in Kubernetes All Kubernetes clusters have two categories of users: service accounts managed by Kubernetes, and normal users.
It is assumed that a cluster-independent service manages normal users in the following ways:
an administrator distributing private keys a user store like Keystore or Google Accounts a file with a list of usernames and passwords In this regard, Kubernetes does not have objects which represent normal user accounts."><meta property="og:title" content="RBAC"><meta property="og:description" content="Role Based Access Control Until now we just assumed that we have the necessary right to do our tasks in kubernetes. But how are users Authenticated and Authorized in Kubernetes/the Kubernetes API?
Users in Kubernetes All Kubernetes clusters have two categories of users: service accounts managed by Kubernetes, and normal users.
It is assumed that a cluster-independent service manages normal users in the following ways:
an administrator distributing private keys a user store like Keystore or Google Accounts a file with a list of usernames and passwords In this regard, Kubernetes does not have objects which represent normal user accounts."><meta property="og:type" content="article"><meta property="og:url" content="/docs/kubernetes-basics/03-security-architecture/03/_rbac/"><meta property="article:section" content="docs"><meta property="article:modified_time" content="2024-10-24T22:53:45+02:00"><meta itemprop=name content="RBAC"><meta itemprop=description content="Role Based Access Control Until now we just assumed that we have the necessary right to do our tasks in kubernetes. But how are users Authenticated and Authorized in Kubernetes/the Kubernetes API?
Users in Kubernetes All Kubernetes clusters have two categories of users: service accounts managed by Kubernetes, and normal users.
It is assumed that a cluster-independent service manages normal users in the following ways:
an administrator distributing private keys a user store like Keystore or Google Accounts a file with a list of usernames and passwords In this regard, Kubernetes does not have objects which represent normal user accounts."><meta itemprop=dateModified content="2024-10-24T22:53:45+02:00"><meta itemprop=wordCount content="1091"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="RBAC"><meta name=twitter:description content="Role Based Access Control Until now we just assumed that we have the necessary right to do our tasks in kubernetes. But how are users Authenticated and Authorized in Kubernetes/the Kubernetes API?
Users in Kubernetes All Kubernetes clusters have two categories of users: service accounts managed by Kubernetes, and normal users.
It is assumed that a cluster-independent service manages normal users in the following ways:
an administrator distributing private keys a user store like Keystore or Google Accounts a file with a list of usernames and passwords In this regard, Kubernetes does not have objects which represent normal user accounts."><link rel=preload href=/scss/main.min.a640f285742d63fc54f2d0a8831ec7331ffac626070575a64961fc7e06c1bf34.css as=style><link href=/scss/main.min.a640f285742d63fc54f2d0a8831ec7331ffac626070575a64961fc7e06c1bf34.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.7.1.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous></script></head><body class=td-page><header><nav class="td-navbar js-navbar-scroll" data-bs-theme=dark><div class="container-fluid flex-column flex-md-row"><a class=navbar-brand href=/><span class="navbar-brand__logo navbar-logo"></span><span class=navbar-brand__name>Kubernetes Security Training</span></a><div class="td-navbar-nav-scroll ms-md-auto" id=main_navbar><ul class=navbar-nav><li class=nav-item><a class=nav-link href=/setup/><span>Setup</span></a></li><li class=nav-item><a class=nav-link href=/slides/><span>Slides</span></a></li><li class=nav-item><a class=nav-link href=https://songlaa.com target=_blank rel=noopener><span>songlaa gmbh</span></a></li></ul></div><div class="d-none d-lg-block"></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><form class="td-sidebar__search d-flex align-items-center"><button class="btn btn-link td-sidebar__toggle d-md-none p-0 ms-3 fas fa-bars" type=button data-bs-toggle=collapse data-bs-target=#td-section-nav aria-controls=td-section-nav aria-expanded=false aria-label="Toggle section navigation"></button></form><nav class="td-sidebar-nav collapse" id=td-section-nav><ul class="td-sidebar-nav__section pe-md-3 ul-0"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-docs-li><a href=/docs/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-docs><span>Labs</span></a><ul class=ul-1><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docskubernetes-basics01-basics-li><a href=/docs/kubernetes-basics/01-basics/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-docskubernetes-basics01-basics><span>1. Basics</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docskubernetes-basics01-basics01_introduction-li><a href=/docs/kubernetes-basics/01-basics/01/_introduction/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docskubernetes-basics01-basics01_introduction><span>1.1. Introduction</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docskubernetes-basics01-basics01_deployments-li><a href=/docs/kubernetes-basics/01-basics/01/_deployments/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docskubernetes-basics01-basics01_deployments><span>1.2. Deployments</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docskubernetes-basics01-basics01_service-li><a href=/docs/kubernetes-basics/01-basics/01/_service/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docskubernetes-basics01-basics01_service><span>1.3. Exposing a service</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docskubernetes-basics01-basics01_database-li><a href=/docs/kubernetes-basics/01-basics/01/_database/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docskubernetes-basics01-basics01_database><span>1.4. Backend</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docskubernetes-basics02-secure-workload-li><a href=/docs/kubernetes-basics/02-secure-workload/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-docskubernetes-basics02-secure-workload><span>2. Secure Workload</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docskubernetes-basics02-secure-workload02_sec-frontend-li><a href=/docs/kubernetes-basics/02-secure-workload/02/_sec-frontend/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docskubernetes-basics02-secure-workload02_sec-frontend><span>2.1. Securing the frontend</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docskubernetes-basics02-secure-workload02_network-policies-li><a href=/docs/kubernetes-basics/02-secure-workload/02/_network-policies/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docskubernetes-basics02-secure-workload02_network-policies><span>2.2. Network Policies</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-docskubernetes-basics03-security-architecture-li><a href=/docs/kubernetes-basics/03-security-architecture/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-docskubernetes-basics03-security-architecture><span>3. Security Architecture</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id=m-docskubernetes-basics03-security-architecture03_rbac-li><a href=/docs/kubernetes-basics/03-security-architecture/03/_rbac/ class="align-left ps-0 active td-sidebar-link td-sidebar-link__page" id=m-docskubernetes-basics03-security-architecture03_rbac><span class=td-sidebar-nav-active-item>3.1. RBAC</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docskubernetes-basics03-security-architecture03_architecture-li><a href=/docs/kubernetes-basics/03-security-architecture/03/_architecture/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docskubernetes-basics03-security-architecture03_architecture><span>3.2. Architecture and encryption</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docskubernetes-basics03-security-architecture03_psa-li><a href=/docs/kubernetes-basics/03-security-architecture/03/_psa/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docskubernetes-basics03-security-architecture03_psa><span>3.3. PSA</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docskubernetes-basics03-security-architecture03_custom-policies-li><a href=/docs/kubernetes-basics/03-security-architecture/03/_custom-policies/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docskubernetes-basics03-security-architecture03_custom-policies><span>3.4. Custom Policies</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docskubernetes-basics03-security-architecture03_runtime-sec-li><a href=/docs/kubernetes-basics/03-security-architecture/03/_runtime-sec/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docskubernetes-basics03-security-architecture03_runtime-sec><span>3.5. Runtime Security</span></a></li></ul></li></ul></li></ul></nav></div></aside><aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none"><div class="td-page-meta ms-2 pb-1 pt-2 mb-0"><a href=https://github.com/songlaa/kubernetes-security-training/tree/main/content/en/docs/kubernetes-basics/03-Security-Architecture/03/_rbac.md class="td-page-meta--view td-page-meta__view" target=_blank rel=noopener><i class="fa-solid fa-file-lines fa-fw"></i> View page source</a>
<a href=https://github.com/songlaa/kubernetes-security-training/edit/main/content/en/docs/kubernetes-basics/03-Security-Architecture/03/_rbac.md class="td-page-meta--edit td-page-meta__edit" target=_blank rel=noopener><i class="fa-solid fa-pen-to-square fa-fw"></i> Edit this page</a>
<a href="https://github.com/songlaa/kubernetes-security-training/new/main/content/en/docs/kubernetes-basics/03-Security-Architecture/03?filename=change-me.md&amp;value=---%0Atitle%3A+%22Long+Page+Title%22%0AlinkTitle%3A+%22Short+Nav+Title%22%0Aweight%3A+100%0Adescription%3A+%3E-%0A+++++Page+description+for+heading+and+indexes.%0A---%0A%0A%23%23+Heading%0A%0AEdit+this+template+to+create+your+new+page.%0A%0A%2A+Give+it+a+good+name%2C+ending+in+%60.md%60+-+e.g.+%60getting-started.md%60%0A%2A+Edit+the+%22front+matter%22+section+at+the+top+of+the+page+%28weight+controls+how+its+ordered+amongst+other+pages+in+the+same+directory%3B+lowest+number+first%29.%0A%2A+Add+a+good+commit+message+at+the+bottom+of+the+page+%28%3C80+characters%3B+use+the+extended+description+field+for+more+detail%29.%0A%2A+Create+a+new+branch+so+you+can+preview+your+new+file+and+request+a+review+via+Pull+Request.%0A" class="td-page-meta--child td-page-meta__child" target=_blank rel=noopener><i class="fa-solid fa-pen-to-square fa-fw"></i> Create child page</a>
<a href="https://github.com/songlaa/kubernetes-security-training/issues/new?title=RBAC" class="td-page-meta--issue td-page-meta__issue" target=_blank rel=noopener><i class="fa-solid fa-list-check fa-fw"></i> Create documentation issue</a></div><div class=td-toc><nav id=TableOfContents><ul><li><a href=#role-based-access-control>Role Based Access Control</a><ul><li><a href=#users-in-kubernetes>Users in Kubernetes</a></li><li><a href=#rbac-authorisation>RBAC Authorisation</a></li><li><a href=#task-311-create-a-new-service-account>Task 3.1.1: Create a New Service Account</a></li></ul></li></ul></nav></div></aside><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><nav aria-label=breadcrumb class=td-breadcrumbs><ol class=breadcrumb><li class=breadcrumb-item><a href=/docs/>Labs</a></li><li class=breadcrumb-item><a href=/docs/kubernetes-basics/03-security-architecture/>Security Architecture</a></li><li class="breadcrumb-item active" aria-current=page>RBAC</li></ol></nav><div class=td-content><h1>3.1. RBAC</h1><header class=article-meta></header><h2 id=role-based-access-control>Role Based Access Control</h2><p>Until now we just assumed that we have the necessary right to do our tasks in kubernetes. But how are users <a href=https://kubernetes.io/docs/reference/access-authn-authz/authentication/ target=_blank rel=noopener>Authenticated</a>
and <a href=https://kubernetes.io/docs/reference/access-authn-authz/rbac/ target=_blank rel=noopener>Authorized</a>
in Kubernetes/the Kubernetes API?</p><h3 id=users-in-kubernetes>Users in Kubernetes</h3><p>All Kubernetes clusters have two categories of users: service accounts managed by Kubernetes, and normal users.</p><p>It is assumed that a cluster-independent service manages normal users in the following ways:</p><ul><li>an administrator distributing private keys</li><li>a user store like Keystore or Google Accounts</li><li>a file with a list of usernames and passwords</li></ul><p>In this regard, Kubernetes does not have objects which represent normal user accounts. Normal users cannot be added to a cluster through an API call.</p><p>Even though a normal user cannot be added via an API call, any user that presents a valid certificate signed by the cluster&rsquo;s certificate authority (CA) is considered authenticated. In this configuration, Kubernetes determines the username from the common name field in the &lsquo;subject&rsquo; of the cert (e.g., &ldquo;/CN=bob&rdquo;).
In contrast, service accounts are users managed by the Kubernetes API. They are bound to specific namespaces, and created automatically by the API server or manually through API calls.</p><h4 id=authentication-strategies>Authentication strategies</h4><p>Kubernetes uses client certificates, bearer tokens, or an authenticating proxy to authenticate API requests through authentication plugins.
As HTTP requests are made to the API server, plugins attempt to associate the following attributes with the request:</p><ul><li>Username: a string which identifies the end user. Common values might be kube-admin or <a href=mailto:jane@example.com>jane@example.com</a>
.</li><li>UID: a string which identifies the end user and attempts to be more consistent and unique than username.</li><li>Groups: a set of strings, each of which indicates the user&rsquo;s membership in a named logical collection of users. Common values might be system:masters or devops-team.</li><li>Extra fields: a map of strings to list of strings which holds additional information authorizers may find useful.</li></ul><p>The following authentication method are common:</p><ul><li>X509 client certificates</li><li>bearer token</li><li>Service account tokens</li><li>OpenID Connect Tokens (Microsoft Entra ID, Salesforce,Google&mldr;)</li></ul><h3 id=rbac-authorisation>RBAC Authorisation</h3><p>The RBAC API declares four kinds of Kubernetes object: Role, ClusterRole, RoleBinding and ClusterRoleBinding. You can describe or amend the RBAC objects using tools such as kubectl, just like any other Kubernetes object.</p><h4 id=role-and-clusterrole>Role and ClusterRole</h4><p>An RBAC Role or ClusterRole contains rules that represent a set of permissions. Permissions are purely additive (there are no &ldquo;deny&rdquo; rules).</p><p>A Role always sets permissions within a particular namespace; when you create a Role, you have to specify the namespace it belongs in.</p><p>ClusterRole, by contrast, is a non-namespaced resource. The resources have different names (Role and ClusterRole) because a Kubernetes object always has to be either namespaced or not namespaced; it can&rsquo;t be both.</p><h4 id=rolebinding-and-clusterrolebinding>RoleBinding and ClusterRoleBinding</h4><p>A role binding grants the permissions defined in a role to a user or set of users. It holds a list of subjects (users, groups, or service accounts), and a reference to the role being granted. A RoleBinding grants permissions within a specific namespace whereas a ClusterRoleBinding grants that access cluster-wide.</p><p>A RoleBinding may reference any Role in the same namespace. Alternatively, a RoleBinding can reference a ClusterRole and bind that ClusterRole to the namespace of the RoleBinding. If you want to bind a ClusterRole to all the namespaces in your cluster, you use a ClusterRoleBinding.</p><h3 id=task-311-create-a-new-service-account>Task 3.1.1: Create a New Service Account</h3><p>In this lab, we will explore how to test Kubernetes RBAC (Role-Based Access Control) using an <strong>explicitly created service account</strong>. Unlike the default service account, which is automatically created in each namespace, we will create our own service account and bind it to a Role that grants permissions to list and create pods.</p><p>Instead of using the default service account, we will create a new service account named <code>&lt;namespace>-sa</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl create serviceaccount &lt;namespace&gt;-sa
</span></span><span style=display:flex><span>kubectl get serviceaccount
</span></span></code></pre></div><p>Next, we will create a pod that uses the newly created <namespace>-sa service account.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl run kubectl-pod --image<span style=color:#ce5c00;font-weight:700>=</span>bitnami/kubectl --restart<span style=color:#ce5c00;font-weight:700>=</span>Never --overrides<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{ &#34;spec&#34;: { &#34;serviceAccount&#34;: &#34;&lt;namespace&gt;-sa&#34; }}&#39;</span> -- sleep infinity
</span></span></code></pre></div><p>We are ready to use kubectl from within our pod to list all pods in the namespace using the <code>&lt;namespace>-sa</code> service account:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl <span style=color:#204a87>exec</span> -it kubectl-pod -- kubectl get pods
</span></span></code></pre></div><p>You will likely see a permission denied error because <code>&lt;namespace>-sa</code> does not have the required permissions to list pods.</p><p>To allow the <code>&lt;namespace>-sa</code> service account to list and create pods, we need to create a Role that grants these permissions.</p><p>Create a file called <code>role.yaml</code> to define a Role that allows listing and creating pods:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>rbac.authorization.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Role</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>&lt;namespace&gt;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>pod-manager</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>apiGroups</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>resources</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;pods&#34;</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>verbs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;list&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;create&#34;</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>apply the Role:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl apply -f role.yaml
</span></span></code></pre></div><p>This Role grants the ability to list and create pods in the <code>&lt;namespace></code> namespace. Kubernetes grants you rights to create roles and rolebindings which do not exceed your own rights.</p><p>Now that we have a Role, we need to bind the <code>&lt;namespace>-sa</code> service account to this Role so that it can use the permissions.</p><p>Create a file called <code>rolebinding.yaml</code> to bind the <code>&lt;namespace>-sa</code> service account to the <code>pod-manager</code> Role:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>rbac.authorization.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>RoleBinding</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>pod-manager-binding</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>subjects</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ServiceAccount</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>&lt;namespace&gt;-sa</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>roleRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Role</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>pod-manager</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>apiGroup</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>rbac.authorization.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>Apply the RoleBinding:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl apply -f rolebinding.yaml
</span></span></code></pre></div><p>The <code>&lt;namespace>-sa</code> service account is now bound to the <code>pod-manager</code> Role, and can list and create pods in the <code>&lt;namespace></code> namespace.</p><p>Kubernetes provides the <code>kubectl auth can-i</code> command to check if a specific action is allowed for a user or service account.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl auth can-i list pods --as<span style=color:#ce5c00;font-weight:700>=</span>system:serviceaccount:&lt;namespace&gt;:&lt;namespace&gt;-sa -n &lt;namespace&gt;
</span></span><span style=display:flex><span>kubectl auth can-i create pods --as<span style=color:#ce5c00;font-weight:700>=</span>system:serviceaccount:&lt;namespace&gt;:&lt;namespace&gt;-sa -n &lt;namespace&gt;
</span></span></code></pre></div><p>Both commands should return <code>yes</code> now that the Role and RoleBinding are in place.</p><p>Now use the Service Account to create a new Pod</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl <span style=color:#204a87>exec</span> -it kubectl-pod -- kubectl run new-pod --image<span style=color:#ce5c00;font-weight:700>=</span>nginx --restart<span style=color:#ce5c00;font-weight:700>=</span>Never
</span></span></code></pre></div><p>Check if the new pod was created:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl get pods
</span></span></code></pre></div><p>You should now see both <code>kubectl-pod</code> and <code>new-pod</code> in the output.</p><p>Feel free to experiment by modifying the Role&rsquo;s permissions or testing different service accounts to better understand Kubernetes RBAC!</p><details><summary>🤔 Can I list secrets whith this service account?</summary><p>You did not include secrets in your role, so you cannot list secrets directly.</p><p>However you have the right to start a pod in this namespace, if you happen to know the name of the secret (or guess it) you can mount any secret in this namespace to the pod an read it inside the pod!</p></details><p>You can delete both pods and the service account after you have finished the lab:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl delete pods kubectl-pod, new-pod
</span></span><span style=display:flex><span>kubectl delete -f role.yaml
</span></span><span style=display:flex><span>kubectl delete -f rolebinding.yaml
</span></span><span style=display:flex><span>kubectl delete sa &lt;namespace&gt;-sa
</span></span></code></pre></div><div class="text-muted mt-5 pt-3"><div class=row><div class=col-sm><a href=/docs/kubernetes-basics/03-security-architecture/ data-toggle=tooltip title="Security Architecture"><i class="fa fa-arrow-circle-left"></i> Previous</a></div><div class="col-sm text-right"><a href=/docs/kubernetes-basics/03-security-architecture/03/_architecture/ data-toggle=tooltip title="Architecture and encryption">Next <i class="fa fa-arrow-circle-right"></i></a></div></div></div><div class=td-page-meta__lastmod>Last modified October 24, 2024: <a href=https://github.com/songlaa/kubernetes-security-training/commit/89d9daf6fb5b68f3025394e23cdaaa6167c53eef>improved ordering of labs (89d9daf)</a></div></div></main></div></div><footer class="td-footer row d-print-none"><div class=container-fluid><div class="row mx-md-2"><div class="td-footer__left col-6 col-sm-4 order-sm-1"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=LinkedIn aria-label=LinkedIn><a target=_blank rel=noopener href=https://linkedin.com/gabriel-graf-6b6446319/ aria-label=LinkedIn><i class="fab fa-linkedin-in"></i></a></li></ul></div><div class="td-footer__right col-6 col-sm-4 order-sm-3"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=GitHub aria-label=GitHub><a target=_blank rel=noopener href=https://github.com/songlaa/kubernetes-security-training aria-label=GitHub><i class="fab fa-github"></i></a></li></ul></div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2"><span class=td-footer__copyright>&copy;
2024
<span class=td-footer__authors>songlaa gmbh</span></span><span class=td-footer__all_rights_reserved>All Rights Reserved</span></div></div></div></footer></div><script src=/js/main.min.d05ad35ff2c6dc165933414181dc1f183f98fc42e97d00f21d8d3d73d13ab4e1.js integrity="sha256-0FrTX/LG3BZZM0FBgdwfGD+Y/ELpfQDyHY09c9E6tOE=" crossorigin=anonymous></script><script defer src=/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js integrity="sha256-c0eKfUgHaYrtfjVesj+YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin=anonymous></script><script src=/js/tabpane-persist.js></script><script src=/js/site.min.f234c71c91fb8841ef090eff193dd6c3ef1a5a351461c0aa2e63a9cea23babc2.js integrity="sha256-8jTHHJH7iEHvCQ7/GT3Ww+8aWjUUYcCqLmOpzqI7q8I=" crossorigin=anonymous></script></body></html>